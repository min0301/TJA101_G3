<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å•†å“ä¿®æ”¹</title>
  <style>
    /* æ²¿ç”¨èˆ‡åˆ—è¡¨é é¡ä¼¼çš„é¢¨æ ¼ï¼Œä¿æŒä¸€è‡´æ€§ */
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0 auto;
      max-width: 800px; /* ç·¨è¼¯é é¢å¯¬åº¦å¯ä»¥çª„ä¸€äº› */
      padding: 20px;
      background-color: #f4f7f6;
      color: #333;
    }
    h1 {
      color: #2c3e50;
      text-align: center;
      margin-bottom: 30px;
    }
    .form-container {
      background-color: #fff;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    .form-group {
      margin-bottom: 20px;
    }
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: bold;
      color: #555;
    }
    .form-group input[type="text"],
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box; /* ç¢ºä¿ padding ä¸æœƒå½±éŸ¿å¯¬åº¦ */
      font-size: 16px;
    }
    .form-group textarea {
      height: 120px;
      resize: vertical;
    }
    .form-group .image-preview {
      max-width: 200px;
      margin-top: 10px;
      border-radius: 5px;
      border: 1px solid #ddd;
    }
    .button-group {
      display: flex;
      justify-content: flex-end; /* æŒ‰éˆ•é å³ */
      gap: 15px;
      margin-top: 30px;
    }
    .btn {
      display: inline-block;
      text-decoration: none;
      color: white;
      padding: 12px 25px;
      border-radius: 5px;
      font-weight: bold;
      border: none;
      cursor: pointer;
      transition: opacity 0.3s;
    }
    .btn:hover { opacity: 0.85; }
    .btn-save { background-color: #3498db; }
    .btn-cancel { background-color: #95a5a6; }
    #error-message {
      color: #e74c3c;
      background-color: #fbecec;
      border: 1px solid #e74c3c;
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 5px;
      display: none; /* é è¨­éš±è— */
    }
  </style>
</head>
<body>

<h1>å•†å“ä¿®æ”¹</h1>

<div id="error-message"></div>

<div class="form-container">
  <form id="edit-form">
    <input type="hidden" id="productId">

    <div class="form-group">
      <label for="product_name">å•†å“åç¨±</label>
      <input type="text" id="product_name" name="proName" required>
    </div>

    <div class="form-group">
      <label for="product_price">åƒ¹æ ¼</label>
      <input id="product_price" name="proPrice" required>
    </div>

    <div class="form-group">
      <label for="product_status">ç‹€æ…‹</label>
      <select id="product_status" name="proStatus" required>
      	<option value="å·²ç™¼å”®">å·²ç™¼å”®</option>
        <option value="é è³¼ä¸­">é è³¼ä¸­</option>
      </select>
    </div>
    
    <div class="form-group">
      <label for="product_version">ç‰ˆæœ¬</label>
      <input type="text" id="product_version" name="proVersion" required>
    </div>
    
    <div class="form-group">
      <label for="product_date">ç™¼å”®æ—¥</label>
      <input type="date" id="product_date" name="proDate" required>
    </div>
    
    <div class="form-group">
      <label for="product_image_upload">æ›´æ–°åœ–ç‰‡ï¼ˆå¯é¸ï¼‰</label>
      <input type="file" id="product_image_upload" name="imageFile" accept="image/*">

      <p style="margin-top: 10px; font-size: 14px; color: #555;">ç›®å‰åœ–ç‰‡é è¦½ï¼š</p>
      <img id="image_preview" src="" alt="åœ–ç‰‡é è¦½" class="image-preview" style="display: none;">
    </div>
    
	<div class="form-group">
      <label for="product_details">æè¿°</label>
      <textarea id="product_details" name="proDetails" required></textarea>
    </div>
    
    <div class="form-group">
      <label for="product_include">å…§å®¹ç‰©</label>
      <textarea id="product_include" name="proInclude" required></textarea>
    </div>
	
	<div class="form-group">
      <label for="product_malltag">å¹³å°</label>
      <select id="product_malltag" name="mallTagName" required></select>
    </div>
     
	<div class="form-group">
      <label for="product_ismarket">ä¸Šä¸‹æ¶</label>
      <select id="product_ismarket" name="proIsmarket" required>
		<option value="0">ä¸Šæ¶</option>
        <option value="1">ä¸‹æ¶</option>
      </select>
    </div>
    
    <div class="button-group">
      <a href="listAllProduct.html" class="btn-cancel">è¿”å›åˆ—è¡¨</a> <button type="submit" class="btn btn-save">å„²å­˜ä¿®æ”¹</button>
    </div>
  </form>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    // ã€å¯è®Šã€‘å¾Œç«¯ API çš„åŸºç¤è·¯å¾‘
    const apiBaseUrl = 'http://localhost:8080/api';

    // ç²å–æ‰€æœ‰è¡¨å–®çš„ DOM å…ƒç´ 
    const form = document.getElementById('edit-form');
    const productIdInput = document.getElementById('productId');
    const nameInput = document.getElementById('product_name');
    const priceInput = document.getElementById('product_price');
    const statusSelect = document.getElementById('product_status');
    const versionSelect = document.getElementById('product_version');
    const dateInput = document.getElementById('product_date');
    const imageUploadInput = document.getElementById('product_image_upload');
    const imagePreview = document.getElementById('image_preview');
    const detailsTextarea = document.getElementById('product_details');
    const includeTextarea = document.getElementById('product_include');
    const malltagSelect = document.getElementById('product_malltag');
    const ismarketSelect = document.getElementById('product_ismarket');
    const errorMessageDiv = document.getElementById('error-message');

    // å¾ URL è®€å–è¦ç·¨è¼¯çš„è«–å£‡ ID
    const urlParams = new URLSearchParams(window.location.search);
    let productId = urlParams.get('id');

    // å¦‚æœ URL ä¸­æ²’æœ‰ IDï¼Œå‰‡é¡¯ç¤ºéŒ¯èª¤ä¸¦åœæ­¢åŸ·è¡Œ
    if (!productId) {
      showError("éŒ¯èª¤ï¼šURLä¸­ç¼ºå°‘å•†å“IDã€‚");
      return;
    }

    // åˆå§‹åŒ–é é¢ï¼Œç²å–æ‰€æœ‰å¿…è¦è³‡æ–™
    async function initializePage() {
      try {
        // ä½¿ç”¨ Promise.all å¹³è¡Œç™¼é€è«‹æ±‚ï¼Œæé«˜æ•ˆç‡
        const [malltag, productData] = await Promise.all([
          fetch(`${apiBaseUrl}/malltag`).then(handleResponse),
          fetch(`${apiBaseUrl}/product/${productId}`).then(handleResponse)
        ]);

        // å¡«å……è¡¨å–®å…§å®¹
        populateMallTag(malltag, productData.mallTagName);
        populateForm(productData);

      } catch (error) {
        showError(`è³‡æ–™è¼‰å…¥å¤±æ•—: ${error.message}`);
      }
    }

    // çµ±ä¸€è™•ç† fetch çš„å›æ‡‰
    function handleResponse(response) {
      if (!response.ok) {
        // å¦‚æœ HTTP ç‹€æ…‹ç¢¼ä¸æ˜¯ 2xxï¼Œå‰‡æ‹‹å‡ºéŒ¯èª¤
        throw new Error(`HTTP éŒ¯èª¤ï¼ ç‹€æ…‹: ${response.status}`);
      }
      return response.json();
    }

    // å¡«å……åˆ†é¡ä¸‹æ‹‰é¸å–®ï¼Œä¸¦è¨­ç½®æ­£ç¢ºçš„é è¨­é¸é …
    function populateMallTag(malltag, selectedMallTagId) {
      malltagSelect.innerHTML = ''; // æ¸…ç©ºç¾æœ‰é¸é …

      malltag.forEach(malltag => {
        const option = document.createElement('option');

        // ã€ä¿®æ­£ã€‘ä½¿ç”¨å¾ API å›å‚³çš„æ­£ç¢ºå±¬æ€§å 'id'
        option.value = malltag.id;
        option.textContent = malltag.mallTagName;

        // ã€ä¿®æ­£ã€‘ä½¿ç”¨ 'id' é€²è¡Œæ¯”è¼ƒï¼Œä¸¦ç¢ºä¿é¡å‹ä¸€è‡´ä¾†é¸ä¸­æ­£ç¢ºé …ç›®
        if (Number(malltag.id) === Number(selectedMallTagId)) {
          option.selected = true;
        }
        malltagSelect.appendChild(option);
      });
    }

    // å°‡å•†å“è³‡æ–™å¡«å……åˆ°è¡¨å–®çš„å„å€‹æ¬„ä½
    function populateForm(data) {
      productIdInput.value =data.id;
      nameInput.value = data.proName;
      priceInput.value = data.proPrice;
      statusSelect.value = data.proStatus;
      versionSelect.value = data.proVersion;
      dateInput.value = data.proDate;
      detailsTextarea.value = data.proDetails;
      includeTextarea.value = data.proInclude;
      malltagSelect.value = data.mallTagNo;
      ismarketSelect.value = data.proIsmarket;
     
      // å¦‚æœæœ‰åœ–ç‰‡ URLï¼Œå‰‡é¡¯ç¤ºé è¦½åœ–
      if (data.proCover) {
        imagePreview.src = `/api/product/cover/${data.id}`;
        imagePreview.style.display = 'block';
      }
    }

    // ç›£è½æª”æ¡ˆä¸Šå‚³å…ƒä»¶çš„è®Šå‹•ï¼Œå³æ™‚é è¦½æ–°é¸æ“‡çš„åœ–ç‰‡
    imageUploadInput.addEventListener('change', function(event) {
      const file = event.target.files[0];
      if (file) {
        const localImageUrl = URL.createObjectURL(file);
        imagePreview.src = localImageUrl;
        imagePreview.style.display = 'block';
      }
    });

    // åœ¨ forum.html çš„ <script> æ¨™ç±¤å…§

// ç›£è½è¡¨å–®æäº¤äº‹ä»¶
    form.addEventListener('submit', async function(event) {
      event.preventDefault(); // é˜»æ­¢ç€è¦½å™¨é è¨­çš„æäº¤è¡Œç‚º
      
      // 1. ã€ä¿®æ­£ã€‘æˆ‘å€‘éœ€è¦å»ºç«‹çš„æ˜¯ä¸€å€‹ FormData ç‰©ä»¶ï¼Œä¸¦ç”¨ä¸€å€‹è®Šæ•¸ (ä¾‹å¦‚ formData) ä¾†æ¥ä½å®ƒã€‚
      const formData = new FormData();

      // 2. ã€ä¿®æ­£ã€‘å®šç¾©è¦è½‰æ›æˆ JSON çš„ç´”è³‡æ–™ç‰©ä»¶ã€‚
      //    ã€å»ºè­°ã€‘ID ç”± URL å‚³éï¼Œbody ä¸­å¯ä»¥ä¸å¿…å†æ”¾ï¼Œè®“å¾Œç«¯ä»¥ URL çš„ ID ç‚ºæº–ã€‚
      const productEditDTO = {
    	     proName : nameInput.value,
    	     proPrice : priceInput.value,
    	     proStatus : statusSelect.value,
    	     proVersion : versionSelect.value,
    	     proDate : dateInput.value,
    	     proDetails : detailsTextarea.value,
    	     proInclude :  includeTextarea.value,
    	     mallTagNo : parseInt(malltagSelect.value),
    	     proIsmarket : ismarketSelect.value
      };

      // 3. ã€ä¿®æ­£ã€‘ä½¿ç”¨ formData è®Šæ•¸ä¾† .append() è³‡æ–™ã€‚
      //    å°‡ forumDto ç‰©ä»¶æ‰“åŒ…æˆ JSON å­—ä¸²ï¼Œä¸¦å‘½åç‚º 'forumDTO'ã€‚
      formData.append('ProductEditDTO', new Blob([JSON.stringify(productEditDTO)], { type: 'application/json' }));

      // 4. ã€ä¿®æ­£ã€‘åŒæ¨£ä½¿ç”¨ formData è®Šæ•¸ä¾† .append() æª”æ¡ˆã€‚
      const imageFile = imageUploadInput.files[0];
      if (imageFile) {
    	  formData.append('imageFile', imageFile);
    	} else {
    	  formData.append('imageFile', new File([], '', { type: 'image/gif' }));
    	}

      try {
        // 5. ã€ä¿®æ­£ã€‘ç™¼é€è«‹æ±‚æ™‚ï¼Œbody æ‡‰è©²æ˜¯æˆ‘å€‘å»ºç«‹å’Œå¡«å……å¥½çš„ formData ç‰©ä»¶ã€‚
        const response = await fetch(`${apiBaseUrl}/admin/product/${productId}`, {
          method: 'PUT',
          body: formData, // ğŸ‘ˆ é€™è£¡æ”¾çš„æ˜¯ formData
        });

        if (!response.ok) {
          const errorData = await response.json().catch(() => ({ message: 'æ›´æ–°å¤±æ•—ï¼Œä¸”ç„¡æ³•è§£æéŒ¯èª¤è¨Šæ¯ã€‚' }));
          throw new Error(errorData.message || 'æ›´æ–°å¤±æ•—');
        }

        alert('æ›´æ–°æˆåŠŸï¼');
        window.location.href = 'listAllProduct.html';

      } catch(error) {
        showError(`å„²å­˜å¤±æ•—: ${error.message}`);
      }
    });

    // é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯çš„è¼”åŠ©å‡½å¼
    function showError(message) {
      errorMessageDiv.style.display = 'block';
      errorMessageDiv.textContent = message;
      console.error(message); // åœ¨ä¸»æ§å°ä¹Ÿå°å‡ºéŒ¯èª¤ï¼Œæ–¹ä¾¿é–‹ç™¼è€…æŸ¥çœ‹
    }

    // åŸ·è¡Œåˆå§‹åŒ–å‡½å¼ï¼Œå•Ÿå‹•æ•´å€‹é é¢
    initializePage();
  });
</script>

</body>
</html>