<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>åƒç´ éƒ¨è½å•†åŸ - å•†å“ä¿®æ”¹</title>
  <style>
   /* å¥¶èŒ¶è‰²ç³»è®Šæ•¸ */
    :root {
      --milktea-bg: #f7f4ed;
      --card-bg: #fff;
      --milktea-yellow: #fff7db;
      --milktea-border: #e8dec7;
      --milktea-brown: #70513b;
      --milktea-main: #ab8556;
      --milktea-hover: #fae7c2;
      --milktea-light: #f4ead8;
      --milktea-accent: #d4b896;
      --milktea-error: #8b4513;
      --milktea-error-bg: #fdf5e6;
    }

    /* åŸºç¤æ¨£å¼ */
    * {
      box-sizing: border-box;
    }

    body {
      font-family: 'å¾®è»Ÿæ­£é»‘é«”', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 20px;
      background: var(--milktea-bg);
      color: var(--milktea-brown);
      min-height: 100vh;
      line-height: 1.6;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
    }

    /* é é¢æ¨™é¡Œ */
    h1 {
      color: var(--milktea-main);
      text-align: center;
      margin-bottom: 40px;
      font-size: 2.5rem;
      font-weight: 700;
      font-family: 'Press Start 2P', Arial, sans-serif;
      letter-spacing: 1px;
      text-shadow: 0 2px 4px rgba(139, 117, 85, 0.1);
      background: linear-gradient(135deg, var(--milktea-yellow) 0%, var(--card-bg) 100%);
      padding: 20px;
      border-radius: 16px;
      border: 2px solid var(--milktea-border);
      box-shadow: 0 4px 20px rgba(139, 117, 85, 0.1);
    }

    /* è¡¨å–®å®¹å™¨ */
    .form-container {
      background: var(--card-bg);
      padding: 40px 35px;
      border-radius: 20px;
      box-shadow: 0 8px 32px rgba(139, 117, 85, 0.15);
      border: 1px solid var(--milktea-border);
      position: relative;
      overflow: hidden;
    }

    .form-container::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 5px;
      background: linear-gradient(90deg, var(--milktea-main) 0%, var(--milktea-accent) 100%);
    }

    /* è¡¨å–®ç¾¤çµ„ */
    .form-group {
      margin-bottom: 25px;
      position: relative;
    }

    .form-group label {
      display: block;
      margin-bottom: 10px;
      font-weight: 600;
      color: var(--milktea-brown);
      font-size: 14px;
      letter-spacing: 0.3px;
      position: relative;
    }

    .form-group label::after {
      content: '';
      position: absolute;
      bottom: -3px;
      left: 0;
      width: 30px;
      height: 2px;
      background: var(--milktea-main);
      border-radius: 1px;
    }

    /* è¼¸å…¥æ¬„ä½æ¨£å¼ */
    .form-group input[type="text"],
    .form-group input[type="date"],
    .form-group input[type="file"],
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 14px 16px;
      border: 2px solid var(--milktea-border);
      border-radius: 12px;
      font-size: 15px;
      font-family: inherit;
      color: var(--milktea-brown);
      background: var(--card-bg);
      transition: all 0.3s ease;
      font-weight: 500;
    }

    .form-group input:focus,
    .form-group textarea:focus,
    .form-group select:focus {
      outline: none;
      border-color: var(--milktea-main);
      box-shadow: 0 0 0 4px rgba(171, 133, 86, 0.1);
      background: var(--milktea-yellow);
    }

    .form-group textarea {
      height: 120px;
      resize: vertical;
      line-height: 1.6;
    }

    /* æª”æ¡ˆä¸Šå‚³ç‰¹æ®Šæ¨£å¼ */
    .form-group input[type="file"] {
      padding: 12px;
      background: var(--milktea-yellow);
      border-style: dashed;
      cursor: pointer;
    }

    .form-group input[type="file"]:hover {
      background: var(--milktea-hover);
      border-color: var(--milktea-main);
    }

    /* åœ–ç‰‡é è¦½ */
    .form-group .image-preview {
      max-width: 250px;
      max-height: 200px;
      margin-top: 15px;
      border-radius: 12px;
      border: 3px solid var(--milktea-border);
      box-shadow: 0 4px 16px rgba(139, 117, 85, 0.1);
      transition: all 0.3s ease;
    }

    .form-group .image-preview:hover {
      transform: scale(1.02);
      border-color: var(--milktea-main);
    }

    /* é è¦½æç¤ºæ–‡å­— */
    .preview-text {
      margin-top: 15px;
      margin-bottom: 8px;
      font-size: 14px;
      color: var(--milktea-brown);
      font-weight: 500;
      opacity: 0.8;
    }

    /* æŒ‰éˆ•ç¾¤çµ„ */
    .button-group {
      display: flex;
      justify-content: flex-end;
      gap: 15px;
      margin-top: 40px;
      padding-top: 25px;
      border-top: 2px solid var(--milktea-light);
    }

    /* æŒ‰éˆ•åŸºæœ¬æ¨£å¼ */
    .btn {
      display: inline-block;
      text-decoration: none;
      color: white;
      padding: 14px 28px;
      border-radius: 12px;
      font-weight: 600;
      border: none;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 15px;
      letter-spacing: 0.5px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      position: relative;
      overflow: hidden;
    }

    .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition: left 0.5s;
    }

    .btn:hover::before {
      left: 100%;
    }

    .btn:hover { 
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.15);
    }

    .btn:active {
      transform: translateY(0);
    }

    /* å„²å­˜æŒ‰éˆ• */
    .btn-save { 
      background: linear-gradient(135deg, var(--milktea-main) 0%, var(--milktea-brown) 100%);
      position: relative;
    }

    .btn-save:hover {
      background: linear-gradient(135deg, var(--milktea-brown) 0%, var(--milktea-main) 100%);
    }

    /* å–æ¶ˆæŒ‰éˆ• */
    .btn-cancel { 
      background: linear-gradient(135deg, var(--milktea-accent) 0%, #9b8b7a 100%);
      color: white;
    }

    .btn-cancel:hover {
      background: linear-gradient(135deg, #9b8b7a 0%, var(--milktea-accent) 100%);
      color: white;
    }

    /* éŒ¯èª¤è¨Šæ¯ */
    #error-message {
      color: var(--milktea-error);
      background: linear-gradient(135deg, var(--milktea-error-bg) 0%, #f4e4bc 100%);
      border: 2px solid #deb887;
      padding: 20px 25px;
      margin-bottom: 25px;
      border-radius: 12px;
      display: none;
      font-weight: 500;
      box-shadow: 0 4px 16px rgba(139, 117, 85, 0.1);
      position: relative;
      border-left: 5px solid var(--milktea-error);
    }

    #error-message::before {
      content: 'âš ï¸';
      margin-right: 10px;
      font-size: 18px;
    }

    /* å¿…å¡«æ¬„ä½æ¨™è¨˜ */
    .form-group label[required]::before {
      content: '* ';
      color: var(--milktea-error);
      font-weight: bold;
    }

    /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
    @media (max-width: 768px) {
      body {
        padding: 15px;
      }

      .container {
        max-width: 100%;
      }

      h1 {
        font-size: 2rem;
        padding: 15px;
        margin-bottom: 25px;
      }

      .form-container {
        padding: 25px 20px;
      }

      .button-group {
        flex-direction: column;
        gap: 12px;
      }

      .btn {
        width: 100%;
        text-align: center;
        padding: 16px 20px;
      }

      .form-group input,
      .form-group textarea,
      .form-group select {
        padding: 12px 14px;
        font-size: 16px; /* é˜²æ­¢ iOS ç¸®æ”¾ */
      }
    }

    @media (max-width: 480px) {
      h1 {
        font-size: 1.6rem;
        letter-spacing: 0.5px;
      }

      .form-container {
        padding: 20px 15px;
        border-radius: 16px;
      }

      .form-group {
        margin-bottom: 20px;
      }

      .image-preview {
        max-width: 100% !important;
      }
    }

    /* è¼‰å…¥å‹•ç•« */
    @keyframes fadeInUp {
      0% { 
        opacity: 0; 
        transform: translateY(30px); 
      }
      100% { 
        opacity: 1; 
        transform: translateY(0); 
      }
    }

    .form-container {
      animation: fadeInUp 0.6s ease-out;
    }

    /* æ·±è‰²ä¸»é¡Œæ”¯æ´ */
    @media (prefers-color-scheme: dark) {
      :root {
        --milktea-bg: #2d2520;
        --card-bg: #3a2f28;
        --milktea-yellow: #4a3d33;
        --milktea-border: #5a4a3d;
        --milktea-brown: #d4b896;
        --milktea-main: #e6c79a;
        --milktea-hover: #4f423a;
        --milktea-light: #4a3d33;
        --milktea-accent: #b8956f;
        --milktea-error: #d4b896;
        --milktea-error-bg: #3a2f28;
      }
    }

    /* ç‰¹æ®Šæ•ˆæœ */
    .form-group:hover label::after {
      width: 50px;
      transition: width 0.3s ease;
    }

    /* Select ä¸‹æ‹‰ç®­é ­è‡ªè¨‚ */
    .form-group select {
      appearance: none;
      background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23ab8556' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
      background-repeat: no-repeat;
      background-position: right 12px center;
      background-size: 20px;
      padding-right: 45px;
    }
  </style>
</head>
<body>

<div class="container">
<a href="/back-end/adm/AdmHomePage.html" class="btn btn-home">å›åˆ°å¾Œå°é¦–é </a>
  <h1>å•†å“ä¿®æ”¹</h1>

  <div id="error-message"></div>

  <div class="form-container">
    <form id="edit-form">
      <input type="hidden" id="productId">

      <div class="form-group">
        <label for="product_name" required>å•†å“åç¨±</label>
        <input type="text" id="product_name" name="proName" required placeholder="è«‹è¼¸å…¥å•†å“åç¨±">
      </div>

      <div class="form-group">
        <label for="product_price" required>åƒ¹æ ¼</label>
        <input type="text" id="product_price" name="proPrice" required placeholder="è«‹è¼¸å…¥åƒ¹æ ¼">
      </div>

      <div class="form-group">
        <label for="product_status" required>ç‹€æ…‹</label>
        <select id="product_status" name="proStatus" required>
          <option value="å·²ç™¼å”®">å·²ç™¼å”®</option>
          <option value="é è³¼ä¸­">é è³¼ä¸­</option>
        </select>
      </div>
      
      <div class="form-group">
        <label for="product_version" required>ç‰ˆæœ¬</label>
        <input type="text" id="product_version" name="proVersion" required placeholder="è«‹è¼¸å…¥ç‰ˆæœ¬è³‡è¨Š">
      </div>
      
      <div class="form-group">
        <label for="product_date" required>ç™¼å”®æ—¥</label>
        <input type="date" id="product_date" name="proDate" required>
      </div>
      
      <div class="form-group">
        <label for="product_image_upload">æ›´æ–°åœ–ç‰‡ï¼ˆå¯é¸ï¼‰</label>
        <input type="file" id="product_image_upload" name="imageFile" accept="image/*">

        <p class="preview-text">ç›®å‰åœ–ç‰‡é è¦½ï¼š</p>
        <img id="image_preview" src="" alt="åœ–ç‰‡é è¦½" class="image-preview" style="display: none;">
      </div>
      
      <div class="form-group">
        <label for="product_details" required>æè¿°</label>
        <textarea id="product_details" name="proDetails" required placeholder="è«‹è¼¸å…¥å•†å“æè¿°"></textarea>
      </div>
      
      <div class="form-group">
        <label for="product_include" required>å…§å®¹ç‰©</label>
        <textarea id="product_include" name="proInclude" required placeholder="è«‹è¼¸å…¥å•†å“å…§å®¹ç‰©"></textarea>
      </div>
    
      <div class="form-group">
        <label for="product_malltag" required>å¹³å°</label>
        <select id="product_malltag" name="mallTagName" required>
          <option value="">è¼‰å…¥ä¸­...</option>
        </select>
      </div>
       
      <div class="form-group">
        <label for="product_ismarket" required>ä¸Šä¸‹æ¶</label>
        <select id="product_ismarket" name="proIsmarket" required>
          <option value="0">ä¸Šæ¶</option>
          <option value="1">ä¸‹æ¶</option>
        </select>
      </div>
      
      <div class="button-group">
        <a href="listAllProduct.html" class="btn btn-cancel">
          <i style="margin-right: 8px;">â†¶</i>è¿”å›åˆ—è¡¨
        </a>
        <button type="submit" class="btn btn-save">
          <i style="margin-right: 8px;">ğŸ’¾</i>å„²å­˜ä¿®æ”¹
        </button>
      </div>
    </form>
  </div>
</div>

<!-- è¼‰å…¥è¦†è“‹å±¤ -->
<div class="loading-overlay" id="loadingOverlay">
  <div class="loading-spinner"></div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    // ã€å¯è®Šã€‘å¾Œç«¯ API çš„åŸºç¤è·¯å¾‘
    const apiBaseUrl = 'http://localhost:8080/api';

    // ç²å–æ‰€æœ‰è¡¨å–®çš„ DOM å…ƒç´ 
    const form = document.getElementById('edit-form');
    const productIdInput = document.getElementById('productId');
    const nameInput = document.getElementById('product_name');
    const priceInput = document.getElementById('product_price');
    const statusSelect = document.getElementById('product_status');
    const versionSelect = document.getElementById('product_version');
    const dateInput = document.getElementById('product_date');
    const imageUploadInput = document.getElementById('product_image_upload');
    const imagePreview = document.getElementById('image_preview');
    const detailsTextarea = document.getElementById('product_details');
    const includeTextarea = document.getElementById('product_include');
    const malltagSelect = document.getElementById('product_malltag');
    const ismarketSelect = document.getElementById('product_ismarket');
    const errorMessageDiv = document.getElementById('error-message');
    const loadingOverlay = document.getElementById('loadingOverlay');

    // å¾ URL è®€å–è¦ç·¨è¼¯çš„å•†å“ ID
    const urlParams = new URLSearchParams(window.location.search);
    let productId = urlParams.get('id');

    // å¦‚æœ URL ä¸­æ²’æœ‰ IDï¼Œå‰‡é¡¯ç¤ºéŒ¯èª¤ä¸¦åœæ­¢åŸ·è¡Œ
    if (!productId) {
      showError("âŒ éŒ¯èª¤ï¼šURLä¸­ç¼ºå°‘å•†å“IDã€‚");
      return;
    }

    // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
    function showLoading() {
      loadingOverlay.style.display = 'flex';
    }

    // éš±è—è¼‰å…¥ç‹€æ…‹
    function hideLoading() {
      loadingOverlay.style.display = 'none';
    }

    // åˆå§‹åŒ–é é¢ï¼Œç²å–æ‰€æœ‰å¿…è¦è³‡æ–™
    async function initializePage() {
      try {
        showLoading();
        
        // ä½¿ç”¨ Promise.all å¹³è¡Œç™¼é€è«‹æ±‚ï¼Œæé«˜æ•ˆç‡
        const [malltag, productData] = await Promise.all([
          fetch(`${apiBaseUrl}/malltag`).then(handleResponse),
          fetch(`${apiBaseUrl}/product/${productId}`).then(handleResponse)
        ]);

        // å¡«å……è¡¨å–®å…§å®¹
        populateMallTag(malltag, productData.mallTagNo);
        populateForm(productData);

      } catch (error) {
        showError(`ğŸ“¡ è³‡æ–™è¼‰å…¥å¤±æ•—: ${error.message}`);
      } finally {
        hideLoading();
      }
    }

    // çµ±ä¸€è™•ç† fetch çš„å›æ‡‰
    function handleResponse(response) {
      if (!response.ok) {
        // å¦‚æœ HTTP ç‹€æ…‹ç¢¼ä¸æ˜¯ 2xxï¼Œå‰‡æ‹‹å‡ºéŒ¯èª¤
        throw new Error(`HTTP éŒ¯èª¤ï¼ ç‹€æ…‹: ${response.status}`);
      }
      return response.json();
    }

    // å¡«å……åˆ†é¡ä¸‹æ‹‰é¸å–®ï¼Œä¸¦è¨­ç½®æ­£ç¢ºçš„é è¨­é¸é …
    function populateMallTag(malltag, selectedMallTagId) {
      malltagSelect.innerHTML = ''; // æ¸…ç©ºç¾æœ‰é¸é …

      malltag.forEach(malltag => {
        const option = document.createElement('option');

        // ä½¿ç”¨å¾ API å›å‚³çš„æ­£ç¢ºå±¬æ€§å 'id'
        option.value = malltag.id;
        option.textContent = malltag.mallTagName;

        // ä½¿ç”¨ 'id' é€²è¡Œæ¯”è¼ƒï¼Œä¸¦ç¢ºä¿é¡å‹ä¸€è‡´ä¾†é¸ä¸­æ­£ç¢ºé …ç›®
        if (Number(malltag.id) === Number(selectedMallTagId)) {
          option.selected = true;
        }
        malltagSelect.appendChild(option);
      });
    }

    // å°‡å•†å“è³‡æ–™å¡«å……åˆ°è¡¨å–®çš„å„å€‹æ¬„ä½
    function populateForm(data) {
      productIdInput.value = data.id;
      nameInput.value = data.proName;
      priceInput.value = data.proPrice;
      statusSelect.value = data.proStatus;
      versionSelect.value = data.proVersion;
      dateInput.value = data.proDate;
      detailsTextarea.value = data.proDetails;
      includeTextarea.value = data.proInclude;
      malltagSelect.value = data.mallTagNo;
      ismarketSelect.value = data.proIsmarket;
     
      // å¦‚æœæœ‰åœ–ç‰‡ URLï¼Œå‰‡é¡¯ç¤ºé è¦½åœ–
      if (data.proCover) {
        imagePreview.src = `/api/product/cover/${data.id}`;
        imagePreview.style.display = 'block';
      }
    }

    // ç›£è½æª”æ¡ˆä¸Šå‚³å…ƒä»¶çš„è®Šå‹•ï¼Œå³æ™‚é è¦½æ–°é¸æ“‡çš„åœ–ç‰‡
    imageUploadInput.addEventListener('change', function(event) {
      const file = event.target.files[0];
      if (file) {
        const localImageUrl = URL.createObjectURL(file);
        imagePreview.src = localImageUrl;
        imagePreview.style.display = 'block';
      }
    });

    // ç›£è½è¡¨å–®æäº¤äº‹ä»¶
    form.addEventListener('submit', async function(event) {
      event.preventDefault(); // é˜»æ­¢ç€è¦½å™¨é è¨­çš„æäº¤è¡Œç‚º
      
      // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
      const submitBtn = form.querySelector('.btn-save');
      const originalText = submitBtn.innerHTML;
      submitBtn.innerHTML = '<i style="margin-right: 8px;">â³</i>è™•ç†ä¸­...';
      submitBtn.disabled = true;
      
      try {
        // 1. å»ºç«‹ FormData ç‰©ä»¶
        const formData = new FormData();

        // 2. å®šç¾©è¦è½‰æ›æˆ JSON çš„ç´”è³‡æ–™ç‰©ä»¶
        const productEditDTO = {
             proName : nameInput.value,
             proPrice : priceInput.value,
             proStatus : statusSelect.value,
             proVersion : versionSelect.value,
             proDate : dateInput.value,
             proDetails : detailsTextarea.value,
             proInclude :  includeTextarea.value,
             mallTagNo : parseInt(malltagSelect.value),
             proIsmarket : ismarketSelect.value
        };

        // 3. å°‡è³‡æ–™åŒ…è£æˆ JSON ä¸¦åŠ å…¥ FormData
        formData.append('ProductEditDTO', new Blob([JSON.stringify(productEditDTO)], { type: 'application/json' }));

        // 4. åŠ å…¥åœ–ç‰‡æª”æ¡ˆ
        const imageFile = imageUploadInput.files[0];
        if (imageFile) {
          formData.append('imageFile', imageFile);
        } else {
          formData.append('imageFile', new File([], '', { type: 'image/gif' }));
        }

        // 5. ç™¼é€è«‹æ±‚
        const response = await fetch(`${apiBaseUrl}/admin/product/${productId}`, {
          method: 'PUT',
          body: formData,
        });

        if (!response.ok) {
          const errorData = await response.json().catch(() => ({ message: 'æ›´æ–°å¤±æ•—ï¼Œä¸”ç„¡æ³•è§£æéŒ¯èª¤è¨Šæ¯ã€‚' }));
          throw new Error(errorData.message || 'æ›´æ–°å¤±æ•—');
        }

        // æˆåŠŸæç¤º
        alert('ğŸ‰ æ›´æ–°æˆåŠŸï¼');
        window.location.href = 'listAllProduct.html';

      } catch(error) {
        showError(`ğŸ’¾ å„²å­˜å¤±æ•—: ${error.message}`);
      } finally {
        // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
      }
    });

    // é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯çš„è¼”åŠ©å‡½å¼
    function showError(message) {
      errorMessageDiv.style.display = 'block';
      errorMessageDiv.textContent = message;
      console.error(message); // åœ¨ä¸»æ§å°ä¹Ÿå°å‡ºéŒ¯èª¤ï¼Œæ–¹ä¾¿é–‹ç™¼è€…æŸ¥çœ‹
      
      // æ»¾å‹•åˆ°éŒ¯èª¤è¨Šæ¯è™•
      errorMessageDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    // éš±è—éŒ¯èª¤è¨Šæ¯
    function hideError() {
      errorMessageDiv.style.display = 'none';
    }

    // è¡¨å–®è¼¸å…¥æ™‚éš±è—éŒ¯èª¤è¨Šæ¯
    form.addEventListener('input', hideError);

    // è¡¨å–®é©—è­‰
    function validateForm() {
      let isValid = true;
      const requiredFields = [nameInput, priceInput, versionSelect, dateInput, detailsTextarea, includeTextarea];
      
      requiredFields.forEach(field => {
        const formGroup = field.closest('.form-group');
        if (!field.value.trim()) {
          formGroup.classList.add('error');
          formGroup.classList.remove('success');
          isValid = false;
        } else {
          formGroup.classList.add('success');
          formGroup.classList.remove('error');
        }
      });
      
      return isValid;
    }

    // å³æ™‚é©—è­‰
    form.addEventListener('input', function(e) {
      const formGroup = e.target.closest('.form-group');
      if (e.target.value.trim()) {
        formGroup.classList.add('success');
        formGroup.classList.remove('error');
      } else {
        formGroup.classList.remove('success');
        formGroup.classList.remove('error');
      }
    });

    // åŸ·è¡Œåˆå§‹åŒ–å‡½å¼ï¼Œå•Ÿå‹•æ•´å€‹é é¢
    initializePage();

    // é é¢è¼‰å…¥å‹•ç•«
    document.body.style.opacity = '0';
    document.body.style.transform = 'translateY(20px)';
    document.body.style.transition = 'all 0.6s ease';
    
    setTimeout(() => {
      document.body.style.opacity = '1';
      document.body.style.transform = 'translateY(0)';
    }, 100);
  });
</script>

</body>
</html>