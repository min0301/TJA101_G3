<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è©•è«–ç®¡ç†</title>
    
    <style>
        /* ç¹¼æ‰¿ä¸»é é¢çš„ CSS è®Šæ•¸ï¼Œç¢ºä¿è¦–è¦ºé¢¨æ ¼ä¸€è‡´ */
        .comment-management-container {
            width: 100%;
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
            font-family: 'Karla', 'å¾®è»Ÿæ­£é»‘é«”', Arial, sans-serif;
        }

        .comment-management-container .page-title-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color, #ddd);
        }

        .comment-management-container .page-title-header h2 {
            font-family: 'Karla', sans-serif;
            font-size: 24px;
            color: var(--text-color, #333);
            font-weight: 700;
            margin: 0;
        }

        .comment-management-container .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .comment-management-container .stat-card {
            background: var(--component-bg, #fff);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid var(--border-color, #ddd);
            text-align: center;
        }

        .comment-management-container .stat-number {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .comment-management-container .stat-label {
            color: var(--text-muted, #6c757d);
            font-size: 14px;
        }

        .comment-management-container .stat-total { color: var(--brand-green, #28a745); }
        .comment-management-container .stat-normal { color: #28a745; }
        .comment-management-container .stat-blocked { color: #dc3545; }

        .comment-management-container .control-bar {
            background: var(--component-bg, #fff);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color, #ddd);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .comment-management-container .filter-group {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .comment-management-container .filter-select {
            border: 1px solid var(--border-color, #ddd);
            border-radius: 6px;
            padding: 8px 12px;
            background: var(--component-bg, #fff);
            color: var(--text-color, #333);
            transition: border-color 0.2s;
        }
        
        .comment-management-container .filter-select:focus {
            border-color: var(--brand-green, #28a745);
            outline: none;
        }

        .comment-management-container .batch-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .comment-management-container .action-btn {
            display: inline-block;
            text-decoration: none;
            background: none;
            border: 1px solid var(--border-color, #ddd);
            color: var(--text-color, #333);
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 14px;
            font-weight: 500;
        }

        .comment-management-container .action-btn:hover {
            background: var(--brand-green-light, #d4edda);
            color: var(--brand-green, #28a745);
            border-color: var(--brand-green, #28a745);
        }

        .comment-management-container .action-btn.btn-danger {
            background: #dc3545;
            border-color: #dc3545;
            color: white;
        }

        .comment-management-container .action-btn.btn-danger:hover {
            background: #c82333;
            border-color: #c82333;
        }

        .comment-management-container .action-btn.btn-success {
            background: #28a745;
            border-color: #28a745;
            color: white;
        }

        .comment-management-container .action-btn.btn-success:hover {
            background: #218838;
            border-color: #218838;
        }

        .comment-management-container .table-container {
            background: var(--component-bg, #fff);
            border-radius: 12px;
            overflow-x: auto;
            border: 1px solid var(--border-color, #ddd);
        }

        .comment-management-container .table {
            width: 100%;
            border-collapse: collapse;
            margin: 0;
        }

        .comment-management-container .table thead {
            background: var(--brand-green-light, #d4edda);
        }

        .comment-management-container .table th {
            color: var(--brand-green, #28a745);
            font-weight: 700;
            text-align: center;
            vertical-align: middle;
            padding: 15px 10px;
            border: none;
            white-space: nowrap;
        }

        .comment-management-container .table td {
            text-align: center;
            vertical-align: middle;
            padding: 12px 10px;
            border-top: 1px solid var(--border-color, #ddd);
            color: var(--text-color, #333);
        }

        .comment-management-container .table tbody tr:hover {
            background-color: var(--brand-green-light, #d4edda);
        }

        /* è©•è«–å…§å®¹ç‰¹æ®Šæ¨£å¼ */
        .comment-management-container .comment-text {
            max-width: 300px;
            text-align: left;
            padding: 8px 12px;
            line-height: 1.4;
            word-wrap: break-word;
        }

        .comment-management-container .comment-text.truncated {
            max-height: 60px;
            overflow: hidden;
            position: relative;
        }

        .comment-management-container .comment-text.truncated::after {
            content: '...';
            position: absolute;
            bottom: 0;
            right: 0;
            background: var(--component-bg, #fff);
            padding-left: 20px;
        }

        .comment-management-container .expand-btn {
            color: var(--brand-green, #28a745);
            cursor: pointer;
            font-size: 12px;
            margin-top: 4px;
        }

        .comment-management-container .expand-btn:hover {
            text-decoration: underline;
        }

        /* æ˜Ÿç´šè©•åˆ†æ¨£å¼ */
        .comment-management-container .star-rating {
            color: #ffc107;
            font-size: 16px;
            white-space: nowrap;
        }

        .comment-management-container .star-rating .empty-star {
            color: #e0e0e0;
        }

        /* ç‹€æ…‹æ¨™ç±¤æ¨£å¼ */
        .comment-management-container .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            white-space: nowrap;
        }

        .comment-management-container .status-normal {
            background-color: #d4edda;
            color: #155724;
        }

        .comment-management-container .status-blocked {
            background-color: #f8d7da;
            color: #721c24;
        }

        /* æ ¸å–æ–¹å¡Šæ¨£å¼ */
        .comment-management-container .checkbox-cell {
            width: 40px;
        }

        .comment-management-container input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        /* åˆ†é æ§åˆ¶é … */
        .comment-management-container .pagination-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
        }

        .comment-management-container .pagination {
            display: flex;
            padding-left: 0;
            list-style: none;
            margin: 0;
        }

        .comment-management-container .pagination-controls .page-item .page-link {
            color: var(--brand-green, #28a745);
            background-color: var(--component-bg, #fff);
            border: 1px solid var(--border-color, #ddd);
            margin: 0 3px;
            padding: 8px 14px;
            border-radius: 6px;
            transition: all 0.2s;
            text-decoration: none;
            display: block;
        }

        .comment-management-container .pagination-controls .page-item.active .page-link {
            z-index: 1;
            color: #fff;
            background-color: var(--brand-green, #28a745);
            border-color: var(--brand-green, #28a745);
        }

        .comment-management-container .pagination-controls .page-item.disabled .page-link {
            color: #6c757d;
            pointer-events: none;
            background-color: #e9ecef;
            border-color: var(--border-color, #ddd);
        }

        .comment-management-container .pagination-controls .page-item .page-link:hover:not(.active) {
            background-color: var(--brand-green-light, #d4edda);
            border-color: var(--brand-green, #28a745);
        }

        .comment-management-container .pagination-info {
            color: var(--text-muted, #6c757d);
            font-size: 14px;
        }

        /* éŒ¯èª¤è¨Šæ¯ */
        .comment-management-container #error-message {
            color: #e74c3c;
            background-color: #fbecec;
            border: 1px solid #e74c3c;
            padding: 15px;
            margin-top: 20px;
            border-radius: 5px;
            display: none;
        }

        /* è­¦å‘Šè¨Šæ¯ */
        .comment-management-container .warning-message {
            color: #856404;
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
        }

        /* è¼‰å…¥ç‹€æ…‹ */
        .comment-management-container .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-muted, #6c757d);
        }

        /* ç©ºç‹€æ…‹ */
        .comment-management-container .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-muted, #6c757d);
        }

        .comment-management-container .empty-state i {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
        @media (max-width: 768px) {
            .comment-management-container .control-bar {
                flex-direction: column;
                align-items: stretch;
            }
            
            .comment-management-container .filter-group {
                flex-direction: column;
                align-items: stretch;
            }
            
            .comment-management-container .table th,
            .comment-management-container .table td {
                padding: 8px 5px;
                font-size: 12px;
            }
            
            .comment-management-container .comment-text {
                max-width: 200px;
            }
        }

        /* å¿«é€Ÿæ“ä½œæŒ‰éˆ• */
        .comment-management-container .quick-action {
            padding: 4px 8px;
            font-size: 12px;
            margin: 0 2px;
        }

        .comment-management-container .quick-action.restore {
            background: #28a745;
            color: white;
            border-color: #28a745;
        }

        .comment-management-container .quick-action.block {
            background: #dc3545;
            color: white;
            border-color: #dc3545;
        }
    </style>
</head>
<body>

<div class="comment-management-container">
    <div class="page-title-header">
        <h2><i class="bi bi-chat-dots me-2"></i>è©•è«–ç®¡ç†</h2>
    </div>

    <!-- çµ±è¨ˆå¡ç‰‡ -->
    <div class="stats-cards">
        <div class="stat-card">
            <div class="stat-number stat-total" id="totalComments">-</div>
            <div class="stat-label">ç¸½è©•è«–æ•¸</div>
        </div>
        <div class="stat-card">
            <div class="stat-number stat-normal" id="normalComments">-</div>
            <div class="stat-label">æ­£å¸¸è©•è«–</div>
        </div>
        <div class="stat-card">
            <div class="stat-number stat-blocked" id="blockedComments">-</div>
            <div class="stat-label">å·²åœæ¬Šè©•è«–</div>
        </div>
    </div>

    <!-- æ§åˆ¶åˆ— -->
    <div class="control-bar">
        <div class="filter-group">
            <div>
                <label for="statusFilter">è©•è«–ç‹€æ…‹ï¼š</label>
                <select id="statusFilter" class="filter-select" onchange="CommentManager.filterByStatus()">
                    <option value="">å…¨éƒ¨è©•è«–</option>
                    <option value="1">æ­£å¸¸è©•è«–</option>
                    <option value="0">å·²åœæ¬Šè©•è«–</option>
                </select>
            </div>
            <div>
                <label for="itemsPerPageFilter">æ¯é é¡¯ç¤ºï¼š</label>
                <select id="itemsPerPageFilter" class="filter-select" onchange="CommentManager.changeItemsPerPage()">
                    <option value="10">10</option>
                    <option value="20" selected>20</option>
                    <option value="50">50</option>
                </select>
            </div>
        </div>
        
        <div class="batch-actions">
            <span id="selectedCount" style="margin-right: 10px; color: var(--text-muted);">å·²é¸æ“‡: 0</span>
            <button class="action-btn btn-danger" onclick="CommentManager.batchBlock()" id="batchBlockBtn" disabled>
                <i class="bi bi-x-circle me-1"></i>æ‰¹é‡åœæ¬Š
            </button>
            <button class="action-btn btn-success" onclick="CommentManager.batchRestore()" id="batchRestoreBtn" disabled>
                <i class="bi bi-check-circle me-1"></i>æ‰¹é‡æ¢å¾©
            </button>
        </div>
    </div>

    <div id="error-message"></div>

    <!-- è©•è«–è¡¨æ ¼ -->
    <div class="table-container">
        <table class="table">
            <thead>
            <tr>
                <th class="checkbox-cell">
                    <input type="checkbox" id="selectAll" onchange="CommentManager.toggleSelectAll()">
                </th>
                <th>è¨‚å–®ç·¨è™Ÿ</th>
                <th>å•†å“åç¨±</th>
                <th>æœƒå“¡</th>
                <th>è©•åˆ†</th>
                <th>è©•è«–å…§å®¹</th>
                <th>è©•è«–æ™‚é–“</th>
                <th>ç‹€æ…‹</th>
                <th>æ“ä½œ</th>
            </tr>
            </thead>
            <tbody id="commentTableBody">
            <tr>
                <td colspan="9" class="loading">
                    <i class="bi bi-arrow-clockwise me-2"></i>è¼‰å…¥ä¸­...
                </td>
            </tr>
            </tbody>
        </table>
    </div>

    <!-- åˆ†é æ§åˆ¶ -->
    <div class="pagination-controls">
        <div class="pagination-info" id="paginationInfo">
            é¡¯ç¤ºç¬¬ - ç­†ï¼Œå…± - ç­†è©•è«–
        </div>
        <nav id="paginationContainer"></nav>
    </div>
</div>

<script>
    (function() {
        'use strict';

        // --- å…¨åŸŸè®Šæ•¸ ---
        let currentPage = 0; // å¾Œç«¯å¾ 0 é–‹å§‹
        let itemsPerPage = 20;
        let totalPages = 0;
        let totalElements = 0;
        let currentFilter = '';
        let selectedComments = new Set();

        // å‹•æ…‹æ±ºå®š API åŸºç¤è·¯å¾‘
        const API_BASE = getApiBaseUrl();

        function getApiBaseUrl() {
            // æª¢æŸ¥æ˜¯å¦æœ‰è¨­å®šçš„ API åŸºç¤è·¯å¾‘
            if (window.API_BASE_URL) {
                return window.API_BASE_URL;
            }
            
            // æ ¹æ“šç•¶å‰åŸŸåè‡ªå‹•åˆ¤æ–·
            const hostname = window.location.hostname;
            const protocol = window.location.protocol;
            const port = window.location.port;
            
            // é–‹ç™¼ç’°å¢ƒ
            if (hostname === 'localhost' || hostname === '127.0.0.1') {
                return `${protocol}//${hostname}:8080`;
            }
            
            // ä¸Šç·šç’°å¢ƒ - ä½¿ç”¨ç›¸åŒçš„å”è­°å’ŒåŸŸå
            return `${protocol}//${hostname}${port ? ':' + port : ''}`;
        }

        // --- DOM å…ƒç´  ---
        const tableBody = document.getElementById('commentTableBody');
        const errorMessageDiv = document.getElementById('error-message');
        const paginationContainer = document.getElementById('paginationContainer');
        const paginationInfo = document.getElementById('paginationInfo');
        const itemsPerPageFilter = document.getElementById('itemsPerPageFilter');
        const statusFilter = document.getElementById('statusFilter');
        const selectAllCheckbox = document.getElementById('selectAll');
        const selectedCountSpan = document.getElementById('selectedCount');
        const batchBlockBtn = document.getElementById('batchBlockBtn');
        const batchRestoreBtn = document.getElementById('batchRestoreBtn');

        // çµ±è¨ˆå…ƒç´ 
        const totalCommentsSpan = document.getElementById('totalComments');
        const normalCommentsSpan = document.getElementById('normalComments');
        const blockedCommentsSpan = document.getElementById('blockedComments');

        // --- åˆå§‹åŒ– ---
        function initializePage() {
            console.log('ğŸ” è©•è«–ç®¡ç†ç’°å¢ƒæª¢æ¸¬:');
            console.log('- ç•¶å‰ç¶²å€:', window.location.href);
            console.log('- API åŸºç¤è·¯å¾‘:', API_BASE);
            console.log('- JWT Token å­˜åœ¨:', !!localStorage.getItem('jwt'));
            
            loadComments();
            loadStatistics();
        }

        // --- æ ¸å¿ƒåŠŸèƒ½ ---
        
        /**
         * è¼‰å…¥è©•è«–è³‡æ–™ - å¢å¼·éŒ¯èª¤è™•ç†
         */
        async function loadComments() {
            const token = localStorage.getItem('jwt');
            if (!token) {
                showError(new Error('è«‹é‡æ–°ç™»å…¥'));
                return;
            }

            try {
                showLoading();
                
                let url;
                if (currentFilter) {
                    // æŒ‰ç‹€æ…‹ç¯©é¸
                    url = `${API_BASE}/api/admin/orderitem/comments/status/${currentFilter}?page=${currentPage}&size=${itemsPerPage}`;
                } else {
                    // æŸ¥è©¢æ‰€æœ‰è©•è«–
                    url = `${API_BASE}/api/admin/orderitem/comments?page=${currentPage}&size=${itemsPerPage}`;
                }

                console.log(`ğŸ“¡ è¼‰å…¥è©•è«–è³‡æ–™: ${url}`);

                const response = await fetchWithRetry(url, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    if (response.status === 500) {
                        throw new Error('ä¼ºæœå™¨å…§éƒ¨éŒ¯èª¤ï¼Œè«‹è¯ç¹«ç³»çµ±ç®¡ç†å“¡');
                    } else if (response.status === 403) {
                        throw new Error('æ²’æœ‰æ¬Šé™æŸ¥çœ‹è©•è«–è³‡æ–™');
                    } else if (response.status === 404) {
                        throw new Error('æ‰¾ä¸åˆ°è©•è«–è³‡æ–™');
                    }
                    throw new Error(`HTTP éŒ¯èª¤ï¼ç‹€æ…‹: ${response.status}`);
                }

                const result = await response.json();
                console.log('âœ… è©•è«–è³‡æ–™è¼‰å…¥æˆåŠŸ');
                
                if (result.content) {
                    // Spring Page æ ¼å¼
                    totalPages = result.totalPages;
                    totalElements = result.totalElements;
                    
                    renderCommentTable(result.content);
                    renderPaginationControls();
                    updatePaginationInfo();
                    hideError();
                } else {
                    throw new Error('è³‡æ–™æ ¼å¼éŒ¯èª¤');
                }

            } catch (error) {
                console.error('âŒ è¼‰å…¥è©•è«–å¤±æ•—:', error);
                showError(error);
            }
        }

        /**
         * è¼‰å…¥çµ±è¨ˆè³‡æ–™ - åŠ å…¥å®¹éŒ¯è™•ç†
         */
        async function loadStatistics() {
            const token = localStorage.getItem('jwt');
            if (!token) return;

            try {
                console.log('ğŸ“Š è¼‰å…¥çµ±è¨ˆè³‡æ–™...');
                const response = await fetchWithRetry(`${API_BASE}/api/admin/orderitem/statistics`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const stats = await response.json();
                    totalCommentsSpan.textContent = stats.totalComments || 0;
                    normalCommentsSpan.textContent = (stats.totalComments - stats.blockedComments) || 0;
                    blockedCommentsSpan.textContent = stats.blockedComments || 0;
                    console.log('âœ… çµ±è¨ˆè³‡æ–™è¼‰å…¥æˆåŠŸ');
                } else {
                    console.warn('âš ï¸ çµ±è¨ˆè³‡æ–™è¼‰å…¥å¤±æ•—ï¼Œä½¿ç”¨é è¨­å€¼');
                    setDefaultStats();
                }
            } catch (error) {
                console.error('âš ï¸ è¼‰å…¥çµ±è¨ˆå¤±æ•—:', error);
                console.log('ğŸ“Œ ä½¿ç”¨é è¨­çµ±è¨ˆå€¼');
                setDefaultStats();
                // ä¸è®“çµ±è¨ˆå¤±æ•—å½±éŸ¿ä¸»è¦åŠŸèƒ½
            }
        }

        function setDefaultStats() {
            totalCommentsSpan.textContent = '?';
            normalCommentsSpan.textContent = '?';
            blockedCommentsSpan.textContent = '?';
        }

        /**
         * å¸¶é‡è©¦çš„ fetch å‡½æ•¸
         */
        async function fetchWithRetry(url, options, retries = 2) {
            console.log(`ğŸŒ API è«‹æ±‚: ${url}`);
            
            for (let i = 0; i <= retries; i++) {
                try {
                    const response = await fetch(url, {
                        ...options,
                        timeout: 10000 // 10ç§’è¶…æ™‚
                    });
                    
                    console.log(`ğŸ“¡ API å›æ‡‰ [${response.status}]: ${url}`);
                    
                    if (!response.ok) {
                        const errorText = await response.text().catch(() => 'Unable to read response');
                        console.error(`âŒ API éŒ¯èª¤ [${response.status}]:`, errorText);
                    }
                    
                    return response;
                } catch (error) {
                    console.error(`ğŸ”¥ ç¶²è·¯éŒ¯èª¤ (å˜—è©¦ ${i + 1}/${retries + 1}):`, error);
                    if (i === retries) throw error;
                    await new Promise(resolve => setTimeout(resolve, 1000 * (i + 1))); // æ¼¸é€²å»¶é²
                }
            }
        }

        /**
         * æ¸²æŸ“è©•è«–è¡¨æ ¼ - æ ¹æ“šå¾Œç«¯ AdminCommentDTO èª¿æ•´
         */
        function renderCommentTable(comments) {
            if (!comments || comments.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="9" class="empty-state">
                            <i class="bi bi-chat-dots"></i>
                            <p>ç›®å‰æ²’æœ‰è©•è«–è³‡æ–™</p>
                        </td>
                    </tr>
                `;
                return;
            }

            tableBody.innerHTML = comments.map(comment => `
                <tr>
                    <td class="checkbox-cell">
                        <input type="checkbox" value="${comment.orderItemNo}" 
                               onchange="CommentManager.toggleSelect(this)">
                    </td>
                    <td>
                        <a href="#" onclick="CommentManager.viewOrderDetail('${comment.orderNo}')" 
                           style="color: var(--brand-green); text-decoration: none;">
                            ${comment.orderNo}
                        </a>
                    </td>
                    <td style="text-align: left; max-width: 150px;">
                        <div style="font-weight: 500;">${escapeHtml(comment.proName || 'å•†å“åç¨±')}</div>
                        <small style="color: var(--text-muted);">NT$ ${comment.productPrice ? comment.productPrice.toLocaleString() : '0'}</small>
                    </td>
                    <td style="text-align: left;">
                        <div style="font-weight: 500;">${escapeHtml(comment.memName || 'æœªçŸ¥')}</div>
                        <small style="color: var(--text-muted);">${escapeHtml(comment.memEmail || '')}</small>
                    </td>
                    <td>${generateStarRating(comment.proStar)}</td>
                    <td class="comment-text ${comment.productComment && comment.productComment.length > 100 ? 'truncated' : ''}" 
                        onclick="CommentManager.toggleCommentExpand(this)">
                        ${escapeHtml(comment.productComment || 'ç„¡è©•è«–å…§å®¹')}
                        ${comment.productComment && comment.productComment.length > 100 ? '<div class="expand-btn">é»æ“Šå±•é–‹</div>' : ''}
                    </td>
                    <td>${formatDateTime(comment.productCommentCrdate)}</td>
                    <td>
                        <span class="status-badge ${comment.proComStatus == '1' ? 'status-normal' : 'status-blocked'}">
                            ${comment.proComStatus == '1' ? 'æ­£å¸¸' : 'å·²åœæ¬Š'}
                        </span>
                    </td>
                    <td>
                        ${comment.proComStatus == '1' ? 
                            `<button class="action-btn quick-action block" onclick="CommentManager.toggleCommentStatus(${comment.orderItemNo}, '0')">
                                <i class="bi bi-x-circle"></i> åœæ¬Š
                             </button>` :
                            `<button class="action-btn quick-action restore" onclick="CommentManager.toggleCommentStatus(${comment.orderItemNo}, '1')">
                                <i class="bi bi-check-circle"></i> æ¢å¾©
                             </button>`
                        }
                    </td>
                </tr>
            `).join('');

            // é‡ç½®é¸æ“‡ç‹€æ…‹
            selectedComments.clear();
            updateBatchButtons();
        }

        /**
         * ç”¢ç”Ÿæ˜Ÿæ˜Ÿè©•åˆ†
         */
        function generateStarRating(rating) {
            if (!rating || rating === 0) {
                return '<span style="color: var(--text-muted);">æœªè©•åˆ†</span>';
            }
            
            let stars = '<div class="star-rating">';
            for (let i = 1; i <= 5; i++) {
                if (i <= rating) {
                    stars += 'â˜…';
                } else {
                    stars += '<span class="empty-star">â˜†</span>';
                }
            }
            stars += `</div>`;
            return stars;
        }

        /**
         * æ¸²æŸ“åˆ†é æ§åˆ¶é …
         */
        function renderPaginationControls() {
            if (totalPages <= 1) {
                paginationContainer.innerHTML = '';
                return;
            }

            let paginationHTML = '<ul class="pagination">';

            // ä¸Šä¸€é æŒ‰éˆ•
            paginationHTML += `
                <li class="page-item ${currentPage === 0 ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="event.preventDefault(); CommentManager.changePage(${currentPage - 1})">ä¸Šä¸€é </a>
                </li>`;

            // é ç¢¼æŒ‰éˆ•ï¼ˆé¡¯ç¤ºç•¶å‰é å‰å¾Œå„2é ï¼‰
            let startPage = Math.max(0, currentPage - 2);
            let endPage = Math.min(totalPages - 1, currentPage + 2);

            if (startPage > 0) {
                paginationHTML += `
                    <li class="page-item">
                        <a class="page-link" href="#" onclick="event.preventDefault(); CommentManager.changePage(0)">1</a>
                    </li>`;
                if (startPage > 1) {
                    paginationHTML += '<li class="page-item disabled"><span class="page-link">...</span></li>';
                }
            }

            for (let i = startPage; i <= endPage; i++) {
                paginationHTML += `
                    <li class="page-item ${i === currentPage ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="event.preventDefault(); CommentManager.changePage(${i})">${i + 1}</a>
                    </li>`;
            }

            if (endPage < totalPages - 1) {
                if (endPage < totalPages - 2) {
                    paginationHTML += '<li class="page-item disabled"><span class="page-link">...</span></li>';
                }
                paginationHTML += `
                    <li class="page-item">
                        <a class="page-link" href="#" onclick="event.preventDefault(); CommentManager.changePage(${totalPages - 1})">${totalPages}</a>
                    </li>`;
            }

            // ä¸‹ä¸€é æŒ‰éˆ•
            paginationHTML += `
                <li class="page-item ${currentPage === totalPages - 1 ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="event.preventDefault(); CommentManager.changePage(${currentPage + 1})">ä¸‹ä¸€é </a>
                </li>`;

            paginationHTML += '</ul>';
            paginationContainer.innerHTML = paginationHTML;
        }

        /**
         * æ›´æ–°åˆ†é è³‡è¨Š
         */
        function updatePaginationInfo() {
            const startIndex = currentPage * itemsPerPage + 1;
            const endIndex = Math.min((currentPage + 1) * itemsPerPage, totalElements);
            paginationInfo.textContent = `é¡¯ç¤ºç¬¬ ${startIndex}-${endIndex} ç­†ï¼Œå…± ${totalElements} ç­†è©•è«–`;
        }

        // --- äº‹ä»¶è™•ç†å‡½å¼ ---
        
        function filterByStatus() {
            currentFilter = statusFilter.value;
            currentPage = 0;
            loadComments();
        }

        function changeItemsPerPage() {
            itemsPerPage = parseInt(itemsPerPageFilter.value);
            currentPage = 0;
            loadComments();
        }

        function changePage(page) {
            if (page < 0 || page >= totalPages) return;
            currentPage = page;
            loadComments();
        }

        // --- é¸æ“‡åŠŸèƒ½ ---
        
        function toggleSelectAll() {
            const checkboxes = tableBody.querySelectorAll('input[type="checkbox"]');
            const isChecked = selectAllCheckbox.checked;
            
            selectedComments.clear();
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = isChecked;
                if (isChecked) {
                    selectedComments.add(parseInt(checkbox.value));
                }
            });
            
            updateBatchButtons();
        }

        function toggleSelect(checkbox) {
            const commentId = parseInt(checkbox.value);
            
            if (checkbox.checked) {
                selectedComments.add(commentId);
            } else {
                selectedComments.delete(commentId);
                selectAllCheckbox.checked = false;
            }
            
            updateBatchButtons();
        }

        function updateBatchButtons() {
            const selectedCount = selectedComments.size;
            selectedCountSpan.textContent = `å·²é¸æ“‡: ${selectedCount}`;
            
            batchBlockBtn.disabled = selectedCount === 0;
            batchRestoreBtn.disabled = selectedCount === 0;
            
            // æ›´æ–°å…¨é¸ç‹€æ…‹
            const allCheckboxes = tableBody.querySelectorAll('input[type="checkbox"]');
            selectAllCheckbox.checked = allCheckboxes.length > 0 && selectedCount === allCheckboxes.length;
        }

        // --- ç‹€æ…‹æ“ä½œåŠŸèƒ½ ---
        
        async function toggleCommentStatus(orderItemNo, newStatus) {
            const token = localStorage.getItem('jwt');
            if (!token) {
                showError(new Error('è«‹é‡æ–°ç™»å…¥'));
                return;
            }

            const actionText = newStatus === '1' ? 'æ¢å¾©' : 'åœæ¬Š';
            if (!confirm(`ç¢ºå®šè¦${actionText}é€™å‰‡è©•è«–å—ï¼Ÿ`)) {
                return;
            }

            try {
                const response = await fetchWithRetry(`${API_BASE}/api/admin/orderitem/${orderItemNo}/status`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ status: newStatus })
                });

                if (response.ok) {
                    showMessage(`è©•è«–${actionText}æˆåŠŸ`, 'success');
                    loadComments();
                    loadStatistics();
                } else {
                    throw new Error(`${actionText}å¤±æ•—`);
                }
            } catch (error) {
                console.error(`${actionText}è©•è«–å¤±æ•—:`, error);
                showError(error);
            }
        }

        async function batchBlock() {
            if (selectedComments.size === 0) return;
            
            if (!confirm(`ç¢ºå®šè¦åœæ¬Šé¸ä¸­çš„ ${selectedComments.size} å‰‡è©•è«–å—ï¼Ÿ`)) {
                return;
            }

            await batchUpdateStatus('0');
        }

        async function batchRestore() {
            if (selectedComments.size === 0) return;
            
            if (!confirm(`ç¢ºå®šè¦æ¢å¾©é¸ä¸­çš„ ${selectedComments.size} å‰‡è©•è«–å—ï¼Ÿ`)) {
                return;
            }

            await batchUpdateStatus('1');
        }

        async function batchUpdateStatus(status) {
            const token = localStorage.getItem('jwt');
            if (!token) {
                showError(new Error('è«‹é‡æ–°ç™»å…¥'));
                return;
            }

            try {
                const response = await fetchWithRetry(`${API_BASE}/api/admin/orderitem/status/batch`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        orderItemNos: Array.from(selectedComments),
                        status: status
                    })
                });

                if (response.ok) {
                    const actionText = status === '1' ? 'æ¢å¾©' : 'åœæ¬Š';
                    showMessage(`æ‰¹é‡${actionText}æˆåŠŸ`, 'success');
                    selectedComments.clear();
                    loadComments();
                    loadStatistics();
                } else {
                    throw new Error('æ‰¹é‡æ“ä½œå¤±æ•—');
                }
            } catch (error) {
                console.error('æ‰¹é‡æ“ä½œå¤±æ•—:', error);
                showError(error);
            }
        }

        // --- è¼”åŠ©åŠŸèƒ½ ---
        
        function toggleCommentExpand(element) {
            if (element.classList.contains('truncated')) {
                element.classList.remove('truncated');
                const expandBtn = element.querySelector('.expand-btn');
                if (expandBtn) {
                    expandBtn.textContent = 'é»æ“Šæ”¶èµ·';
                }
            } else if (element.textContent.length > 100) {
                element.classList.add('truncated');
                const expandBtn = element.querySelector('.expand-btn');
                if (expandBtn) {
                    expandBtn.textContent = 'é»æ“Šå±•é–‹';
                }
            }
        }

        function viewOrderDetail(orderNo) {
            // é€™è£¡å¯ä»¥è·³è½‰åˆ°è¨‚å–®è©³æƒ…é é¢
            if (typeof loadExternalPage === 'function') {
                loadExternalPage(`../shopsys/order/editOrder.html?orderNo=${orderNo}`);
            } else {
                alert(`æŸ¥çœ‹è¨‚å–® ${orderNo} çš„è©³ç´°è³‡è¨Š`);
            }
        }

        // --- è¼”åŠ©å‡½å¼ ---
        
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showLoading() {
            tableBody.innerHTML = `
                <tr>
                    <td colspan="9" class="loading">
                        <i class="bi bi-arrow-clockwise me-2"></i>è¼‰å…¥ä¸­...
                    </td>
                </tr>
            `;
        }

        function showError(error) {
            console.error('è©•è«–ç®¡ç†éŒ¯èª¤:', error);
            errorMessageDiv.style.display = 'block';
            errorMessageDiv.innerHTML = `
                <strong>è¼‰å…¥å¤±æ•—ï¼</strong> ${error.message}
            `;
            tableBody.innerHTML = `
                <tr>
                    <td colspan="9" style="text-align:center; padding: 40px; color: #e74c3c;">
                        è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–é‡æ–°æ•´ç†é é¢
                    </td>
                </tr>
            `;
        }

        function hideError() {
            errorMessageDiv.style.display = 'none';
        }

        function showMessage(message, type) {
            // é€™è£¡å¯ä»¥ä½¿ç”¨é€šçŸ¥çµ„ä»¶ï¼Œæš«æ™‚ç”¨ alert
            alert(message);
        }

        function formatDateTime(dateTimeStr) {
            if (!dateTimeStr) return '-';
            try {
                return new Date(dateTimeStr).toLocaleString('zh-TW', { 
                    hour12: false,
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch (e) {
                return dateTimeStr;
            }
        }

        // --- å…¨åŸŸæš´éœ² ---
        window.CommentManager = {
            filterByStatus,
            changeItemsPerPage,
            changePage,
            toggleSelectAll,
            toggleSelect,
            toggleCommentStatus,
            batchBlock,
            batchRestore,
            toggleCommentExpand,
            viewOrderDetail
        };

        // --- åˆå§‹åŒ– ---
        initializePage();

    })();
</script>

</body>
</html>